<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panen Kandang Jahaman</title>
  <!-- jsPDF dan html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, Arial, sans-serif; 
      padding: 16px; 
      margin: 0;
    }
    .wrap { max-width: 980px; margin: 0 auto; }

    h1 {
      text-align: center;
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #1f2937;
      font-weight: 700;
    }

    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-bottom: 20px;
    }
    th, td { 
      border: 1px solid #601111; 
      padding: 8px; 
      text-align: center; 
    }
    thead th { background: #f6f6f6; }
    tfoot td { background: #fafafa; font-weight: 600; }

    input[type="number"] { 
      width: 100%; 
      box-sizing: border-box; 
      padding: 6px; 
    }

    /* Layout 2 kolom responsif */
    .bottom-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    /* Responsif untuk mobile */
    @media (max-width: 640px) {
      .bottom-section {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      h1 {
        font-size: 20px;
      }
    }

    .left-side, .right-side {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .label { 
      font-weight: 600; 
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .output-label {
      font-weight: 600;
      font-size: 14px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .output-value {
      display: block;
      padding: 8px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 4px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #1d4ed8;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .error-msg {
      color: #dc2626;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    .error-msg.show {
      display: block;
    }

    /* Styling untuk PDF content */
    #pdf-content {
      display: none;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: white;
    }

    #pdf-content h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
    }

    #pdf-content .info-section {
      margin-bottom: 20px;
      line-height: 1.8;
    }

    #pdf-content .info-section p {
      margin: 4px 0;
    }

    /* Fix clipping + biar nyaman di HP */
  input, button {
    font-size: 16px;      /* mencegah zoom & biasanya lebih stabil di iOS */
    line-height: 1.2;     /* cegah text kepotong */
  }

  /* Khusus input di tabel */
  #tbl input.w {
    line-height: 1.2;
    height: 38px;         /* kasih tinggi yang pasti supaya tidak ke-clip */
    padding: 6px 8px;
  }

  /* Opsional: hilangkan spinner number di WebKit (kadang ganggu layout) */
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"] { -moz-appearance: textfield; }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panen Kandang Jahaman</h1>

    <table id="tbl">
      <thead>
        <tr>
          <th>No</th>
          <th>A</th>
          <th>B</th>
          <th>C</th>
          <th>D</th>
          <th>E</th>
        </tr>
      </thead>

      <tbody id="tbody"></tbody>

      <tfoot>
        <tr>
          <td>Total</td>
          <td id="colTotal0">0.0</td>
          <td id="colTotal1">0.0</td>
          <td id="colTotal2">0.0</td>
          <td id="colTotal3">0.0</td>
          <td id="colTotal4">0.0</td>
        </tr>
      </tfoot>
    </table>

    <div class="bottom-section">
      <!-- Sisi Kiri -->
      <div class="left-side">
        <div class="form-group">
          <label class="label" for="totalEkor">Total ekor</label>
          <input id="totalEkor" type="number" min="0" step="1" inputmode="numeric" placeholder="Misal: 20" />
        </div>

        <div class="form-group">
          <span class="output-label">Berat bersih:</span>
          <span class="output-value" id="totalBerat">0.0</span>
        </div>

        <div class="form-group">
          <span class="output-label">BW bersih:</span>
          <span class="output-value" id="beratBersih">0.00</span>
        </div>
      </div>

      <!-- Sisi Kanan -->
      <div class="right-side">
        <div class="form-group">
          <label class="label" for="namaDO">Nama DO</label>
          <input id="namaDO" type="text" placeholder="Masukkan nama DO" />
        </div>

        <div class="form-group">
          <label class="label" for="tanggalPanen">Tanggal Panen</label>
          <input id="tanggalPanen" type="text" placeholder="DD/MM/YYYY" maxlength="10" />
        </div>

        <div class="form-group">
          <label class="label" for="jamPanen">Jam Panen</label>
          <input id="jamPanen" type="text" placeholder="HH:MM (24 jam)" maxlength="5" />
        </div>

        <div class="form-group">
          <button id="btnExport">Export PDF</button>
          <div class="error-msg" id="errorMsg">Harap isi semua field!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden content untuk PDF -->
  <div id="pdf-content">
    <h2>Panen Kandang Jahaman</h2>
    <div class="info-section" id="pdfInfo"></div>
    <div id="pdfTable"></div>
  </div>

  <script>
    window.jsPDF = window.jspdf.jsPDF;
    
    const ROWS = 20;
    const COLS = 5;

    const tbody = document.getElementById('tbody');
    const totalEkorEl = document.getElementById('totalEkor');
    const totalBeratEl = document.getElementById('totalBerat');
    const beratBersihEl = document.getElementById('beratBersih');
    const colTotalEls = Array.from({ length: COLS }, (_, i) => document.getElementById(`colTotal${i}`));

    const namaDOEl = document.getElementById('namaDO');
    const tanggalPanenEl = document.getElementById('tanggalPanen');
    const jamPanenEl = document.getElementById('jamPanen');
    const btnExportEl = document.getElementById('btnExport');
    const errorMsgEl = document.getElementById('errorMsg');

    // Generate 20 baris x 5 kolom input
    for (let r = 0; r < ROWS; r++) {
      const tr = document.createElement('tr');

      const tdNo = document.createElement('td');
      tdNo.textContent = String(r + 1);
      tr.appendChild(tdNo);

      for (let c = 0; c < COLS; c++) {
        const td = document.createElement('td');
        const inp = document.createElement('input');

        inp.type = 'number';
        inp.step = '0.1';
        inp.min = '0';
        inp.inputMode = 'decimal';
        inp.placeholder = '0.0';
        inp.className = 'w';
        inp.dataset.col = String(c);

        inp.addEventListener('input', hitung);

        inp.addEventListener('blur', () => {
          const v = parseFloat(inp.value);
          if (!Number.isFinite(v)) { inp.value = ''; hitung(); return; }
          inp.value = (Math.round(v * 10) / 10).toFixed(1);
          hitung();
        });

        td.appendChild(inp);
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    totalEkorEl.addEventListener('input', hitung);

    // Format tanggal DD/MM/YYYY
    tanggalPanenEl.addEventListener('input', (e) => {
      let val = e.target.value.replace(/\D/g, '');
      if (val.length >= 2) val = val.slice(0, 2) + '/' + val.slice(2);
      if (val.length >= 5) val = val.slice(0, 5) + '/' + val.slice(5, 9);
      e.target.value = val;
    });

    // Format jam HH:MM
    jamPanenEl.addEventListener('input', (e) => {
      let val = e.target.value.replace(/\D/g, '');
      if (val.length >= 2) val = val.slice(0, 2) + ':' + val.slice(2, 4);
      e.target.value = val;
    });

        // Custom Tab/Enter Navigation (vertikal)
    tbody.addEventListener('keydown', function(e) {
      // Tab atau Enter
      if ((e.key === 'Tab' || e.key === 'Enter') && e.target.classList.contains('w')) {
        e.preventDefault();
        
        const currentInput = e.target;
        const currentRow = parseInt(currentInput.closest('tr').querySelector('td:first-child').textContent) - 1;
        const currentCol = parseInt(currentInput.dataset.col);
        
        let nextRow, nextCol;
        
        if (e.shiftKey && e.key === 'Tab') {
          // Shift+Tab: ke atas
          nextRow = currentRow - 1;
          nextCol = currentCol;
          
          if (nextRow < 0) {
            nextRow = ROWS - 1;
            nextCol = currentCol - 1;
          }
          
          if (nextCol < 0) return;
        } else {
          // Tab atau Enter: ke bawah
          nextRow = currentRow + 1;
          nextCol = currentCol;
          
          if (nextRow >= ROWS) {
            nextRow = 0;
            nextCol = currentCol + 1;
          }
          
          if (nextCol >= COLS) return;
        }
        
        // Fokus ke input berikutnya
        const nextTr = tbody.querySelectorAll('tr')[nextRow];
        const nextInput = nextTr.querySelectorAll('input.w')[nextCol];
        if (nextInput) {
          nextInput.focus();
          nextInput.select();
        }
      }
    });


    function hitung() {
      const inputs = document.querySelectorAll('#tbl input.w');

      let total = 0;
      const colTotals = new Array(COLS).fill(0);

      inputs.forEach(el => {
        const v = parseFloat(el.value);
        if (!Number.isFinite(v)) return;

        total += v;

        const c = parseInt(el.dataset.col, 10);
        if (Number.isFinite(c) && c >= 0 && c < COLS) colTotals[c] += v;
      });

      for (let c = 0; c < COLS; c++) {
        colTotalEls[c].textContent = colTotals[c].toFixed(1);
      }

      const ekor = parseInt(totalEkorEl.value, 10);
      const bersih = (Number.isFinite(ekor) && ekor > 0) ? (total / ekor) : 0;

      totalBeratEl.textContent = total.toFixed(1);
      beratBersihEl.textContent = bersih.toFixed(2);
    }

    // Validasi tanggal DD/MM/YYYY
    function isValidDate(dateStr) {
      const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const match = dateStr.match(regex);
      if (!match) return false;
      
      const day = parseInt(match[1], 10);
      const month = parseInt(match[2], 10);
      const year = parseInt(match[3], 10);
      
      if (month < 1 || month > 12) return false;
      if (day < 1 || day > 31) return false;
      if (year < 1900 || year > 2100) return false;
      
      return true;
    }

    // Validasi jam HH:MM
    function isValidTime(timeStr) {
      const regex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
      return regex.test(timeStr);
    }

    // Export PDF dengan jsPDF + html2canvas
    btnExportEl.addEventListener('click', async () => {
      errorMsgEl.classList.remove('show');

      const namaDO = namaDOEl.value.trim();
      const tanggalPanen = tanggalPanenEl.value.trim();
      const jamPanen = jamPanenEl.value.trim();
      const totalEkor = totalEkorEl.value.trim();

      // Validasi semua field harus terisi
      if (!namaDO || !tanggalPanen || !jamPanen || !totalEkor) {
        errorMsgEl.textContent = 'Harap isi semua field!';
        errorMsgEl.classList.add('show');
        return;
      }

      // Validasi format tanggal
      if (!isValidDate(tanggalPanen)) {
        errorMsgEl.textContent = 'Format tanggal tidak valid! Gunakan DD/MM/YYYY';
        errorMsgEl.classList.add('show');
        return;
      }

      // Validasi format jam
      if (!isValidTime(jamPanen)) {
        errorMsgEl.textContent = 'Format jam tidak valid! Gunakan HH:MM (00:00 - 23:59)';
        errorMsgEl.classList.add('show');
        return;
      }

      // Generate nama file
      const dateParts = tanggalPanen.split('/');
      const day = dateParts[0];
      const month = dateParts[1];
      const year = dateParts[2];
      const namaDOClean = namaDO.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
      const fileName = `laporan-panen-do-${namaDOClean}-${day}-${month}-${year}.pdf`;

      btnExportEl.disabled = true;
      btnExportEl.textContent = 'Mengekspor...';

      try {
        // Siapkan konten PDF
        const pdfInfo = document.getElementById('pdfInfo');
        pdfInfo.innerHTML = `
          <p><strong>Nama DO:</strong> ${namaDO}</p>
          <p><strong>Tanggal Panen:</strong> ${tanggalPanen}</p>
          <p><strong>Jam Panen:</strong> ${jamPanen}</p>
          <p><strong>Total Ekor:</strong> ${totalEkor}</p>
          <p><strong>Berat Bersih:</strong> ${totalBeratEl.textContent}</p>
          <p><strong>BW Bersih:</strong> ${beratBersihEl.textContent}</p>
        `;

        // Clone tabel
        const tableClone = document.getElementById('tbl').cloneNode(true);
        const pdfTableDiv = document.getElementById('pdfTable');
        pdfTableDiv.innerHTML = '';
        pdfTableDiv.appendChild(tableClone);

        const pdfContent = document.getElementById('pdf-content');
        pdfContent.style.display = 'block';

        // Capture dengan html2canvas dengan kualitas tinggi
        const canvas = await html2canvas(pdfContent, {
          scale: 2,
          useCORS: true,
          logging: false,
          letterRendering: true,
          allowTaint: false,
          backgroundColor: '#ffffff'
        });

        pdfContent.style.display = 'none';

        // Convert ke PDF
        const imgData = canvas.toDataURL('image/jpeg', 0.98);
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });

        const imgWidth = 297; // A4 landscape width
        const pageHeight = 210; // A4 landscape height
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        // Add first page
        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // Add more pages if needed
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save(fileName);

      } catch (error) {
        console.error('Error generating PDF:', error);
        errorMsgEl.textContent = 'Gagal membuat PDF. Silakan coba lagi.';
        errorMsgEl.classList.add('show');
      } finally {
        btnExportEl.disabled = false;
        btnExportEl.textContent = 'Export PDF';
      }
    });

    hitung();
  </script>
</body>
</html>
